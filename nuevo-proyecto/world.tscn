[gd_scene load_steps=23 format=4 uid="uid://bagibq6uter7j"]

[ext_resource type="PackedScene" uid="uid://dgpjxoygnvyy4" path="res://assets/simple_fpsplayer/Player.tscn" id="1_f3sb7"]
[ext_resource type="Script" uid="uid://cc6q1eio36k0o" path="res://voxel_lod_terrain.gd" id="1_fj7yv"]
[ext_resource type="Script" uid="uid://d2fpgtp0l4te2" path="res://ZonaCarga.gd" id="3_tlwt5"]
[ext_resource type="PackedScene" uid="uid://soelbkfse7qm" path="res://ecenas/TierraFisica.tscn" id="4_aqk2v"]

[sub_resource type="ProceduralSkyMaterial" id="ProceduralSkyMaterial_fj7yv"]
sky_horizon_color = Color(0.66224277, 0.6717428, 0.6867428, 1)
ground_horizon_color = Color(0.66224277, 0.6717428, 0.6867428, 1)

[sub_resource type="Sky" id="Sky_tlwt5"]
sky_material = SubResource("ProceduralSkyMaterial_fj7yv")

[sub_resource type="Environment" id="Environment_aqk2v"]
background_mode = 2
sky = SubResource("Sky_tlwt5")
tonemap_mode = 2
glow_enabled = true

[sub_resource type="Shader" id="Shader_036b0"]
code = "shader_type spatial;

// From Voxel Tools API
uniform int u_transition_mask;

// Textures should preferably be in a Texture2DArray, so looking them up is cheap
uniform sampler2DArray u_texture_array : source_color, filter_nearest;

// We'll need to pass data from the vertex shader to the fragment shader
varying vec4 v_indices;
varying vec4 v_weights;
varying vec3 v_normal;
varying vec3 v_pos;

// We'll use a utility function to decode components.
// It returns 4 values in the range [0..255].
vec4 decode_8bit_vec4(float v) {
    uint i = floatBitsToUint(v);
    return vec4(
        float(i & uint(0xff)),
        float((i >> uint(8)) & uint(0xff)),
        float((i >> uint(16)) & uint(0xff)),
        float((i >> uint(24)) & uint(0xff)));
}

// A voxel mesh can have overhangs in any direction,
// so we may have to use triplanar mapping functions.
vec3 get_triplanar_blend(vec3 world_normal) {
    vec3 blending = abs(world_normal);
    blending = normalize(max(blending, vec3(0.00001))); // Force weights to sum to 1.0
    float b = blending.x + blending.y + blending.z;
    return blending / vec3(b, b, b);
}

vec4 texture_array_triplanar(sampler2DArray tex, vec3 world_pos, vec3 blend, float i) {
    vec4 xaxis = texture(tex, vec3(world_pos.yz, i));
    vec4 yaxis = texture(tex, vec3(world_pos.xz, i));
    vec4 zaxis = texture(tex, vec3(world_pos.xy, i));
    // blend the results of the 3 planar projections.
    return xaxis * blend.x + yaxis * blend.y + zaxis * blend.z;
}

float get_transvoxel_secondary_factor(int idata) {
	int transition_mask = u_transition_mask & 0xff;

	int cell_border_mask = idata & 63; // Which sides the cell is touching
	int vertex_border_mask = (idata >> 8) & 63; // Which sides the vertex is touching
	// If the vertex is near a side where there is a low-resolution neighbor,
	// move it to secondary position
	int m = transition_mask & cell_border_mask;
	float t = float(m != 0);
	// If the vertex lies on one or more sides, and at least one side has no low-resolution neighbor,
	// don't move the vertex.
	t *= float((vertex_border_mask & ~transition_mask) == 0);
	
	// Debugging
	//t *= 0.5 + 0.5 * sin(TIME * 4.0);
	//t *= 2.0;

	return t;
}

vec3 get_transvoxel_position(vec3 vertex_pos, vec4 fdata) {
	int idata = floatBitsToInt(fdata.a);

	// Move vertices to smooth transitions
	float secondary_factor = get_transvoxel_secondary_factor(idata);
	vec3 secondary_position = fdata.xyz;
	vec3 pos = mix(vertex_pos, secondary_position, secondary_factor);

	// If the mesh combines transitions and the vertex belongs to a transition,
	// when that transition isn't active we change the position of the vertices so
	// all triangles will be degenerate and won't be visible.
	// This is an alternative to rendering them separately,
	// which has less draw calls and less mesh resources to create in Godot.
	// Ideally I would tweak the index buffer like LOD does but Godot does not
	// expose anything to use it that way.
	int itransition = (idata >> 16) & 0xff; // Is the vertex on a transition mesh?
	float transition_cull = float(itransition == 0 || (itransition & u_transition_mask) != 0);
	pos *= transition_cull;

	return pos;
}

void vertex() {
	VERTEX = get_transvoxel_position(VERTEX, CUSTOM0);
	
    // Indices are integer values so we can decode them as-is
    v_indices = decode_8bit_vec4(CUSTOM1.x);

    // Weights must be in [0..1] so we divide them
    v_weights = decode_8bit_vec4(CUSTOM1.y) / 255.0;

    v_pos = VERTEX;
    v_normal = NORMAL;

    //...
}

void fragment() {
    // Define a texture scale for convenience.
    // We can use an array instead if different scales per index is needed.
    float uv_scale = 0.5;

    // Sample the 4 blending textures, all with triplanar mapping.
    // We can re-use the same triplanar blending factors for all of them so separating that part
    // of the function improves performance a little.
    vec3 blending = get_triplanar_blend(v_normal);
    vec3 col0 = texture_array_triplanar(u_texture_array, v_pos * uv_scale, blending, v_indices.x).rgb;
    vec3 col1 = texture_array_triplanar(u_texture_array, v_pos * uv_scale, blending, v_indices.y).rgb;
    vec3 col2 = texture_array_triplanar(u_texture_array, v_pos * uv_scale, blending, v_indices.z).rgb;
    vec3 col3 = texture_array_triplanar(u_texture_array, v_pos * uv_scale, blending, v_indices.w).rgb;

    // Get weights and make sure they are normalized.
    // We may add a tiny safety margin so we can afford some degree of error.
    vec4 weights = v_weights;
    weights /= (weights.x + weights.y + weights.z + weights.w + 0.00001);

    // Calculate albedo
    vec3 col = 
        col0 * weights.r + 
        col1 * weights.g + 
        col2 * weights.b + 
        col3 * weights.a;

    ALBEDO = col;

    //...
}"

[sub_resource type="Image" id="Image_aqk2v"]
data = {
"data": PackedByteArray("fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8cnJycnJycnJyfHx8cnJycnJyfHx8fHx8fHx8fHx8fHx8cnJycnJycnJycnJyfHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8goKCgoKCfHx8fHx8fHx8fHx8fHx8goKCgoKCgoKCgoKCfHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8cnJycnJyfHx8fHx8cnJycnJycnJycnJycnJycnJyfHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8goKCgoKCfHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8cnJycnJycnJycnJycnJycnJycnJyfHx8fHx8fHx8cnJyfHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8goKCgoKCgoKCfHx8fHx8fHx8fHx8fHx8fHx8goKCgoKCcnJycnJyfHx8fHx8fHx8fHx8cnJycnJycnJycnJyfHx8fHx8cnJycnJycnJycnJyfHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8goKCgoKCgoKCgoKCfHx8fHx8fHx8fHx8fHx8goKCgoKCgoKCgoKCfHx8cnJycnJyfHx8cnJycnJycnJycnJycnJyfHx8fHx8cnJycnJycnJycnJycnJycnJyfHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8cnJycnJycnJycnJycnJyfHx8fHx8fHx8fHx8fHx8fHx8fHx8goKCgoKC"),
"format": "RGB8",
"height": 16,
"mipmaps": false,
"width": 16
}

[sub_resource type="Image" id="Image_036b0"]
data = {
"data": PackedByteArray("I4c9I4c9I4c9I4c9JpNDI4c9I4c9JpNDH3c2I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9H3c2I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9H3c2I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9H3c2I4c9JpNDI4c9I4c9I4c9JpNDI4c9I4c9H3c2I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9JpNDI4c9I4c9H3c2I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9H3c2I4c9I4c9JpNDI4c9I4c9I4c9H3c2I4c9I4c9I4c9I4c9I4c9I4c9JpNDI4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9H3c2I4c9I4c9I4c9I4c9I4c9H3c2I4c9I4c9I4c9H3c2I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9JpNDI4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9H3c2I4c9I4c9JpNDI4c9I4c9I4c9I4c9I4c9I4c9I4c9H3c2I4c9I4c9I4c9JpNDI4c9I4c9I4c9I4c9H3c2I4c9I4c9I4c9I4c9JpNDI4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9JpNDI4c9I4c9JpNDI4c9I4c9I4c9I4c9I4c9H3c2I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9JpNDI4c9I4c9I4c9JpNDI4c9I4c9H3c2I4c9I4c9I4c9I4c9I4c9H3c2JpNDI4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9I4c9H3c2I4c9"),
"format": "RGB8",
"height": 16,
"mipmaps": false,
"width": 16
}

[sub_resource type="Image" id="Image_dwbse"]
data = {
"data": PackedByteArray("8sOT8sOT8sOT8sOT8sOT8sOT5biL5biL5biL5biL5biL5biL5biL5biL5biL5biLxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxx5biL5biL5biL5biL5biL5biL5biL5biL5biL8sOT8sOT8sOT8sOT8sOT8sOT8sOT26x95biL26x926x95biL5biL26x926x926x926x95biL5biL5biL5biL26x926x95biL5biL8sOT8sOT8sOT8sOT5biL5biL5biL5biL5biL5biL5biL5biL5biL5biLxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxx5biL5biL5biL5biL5biL5biL5biL8sOT8sOT8sOT8sOT8sOT8sOT8sOT8sOT5biL5biL26x926x95biL26x926x926x926x95biL5biL5biL26x926x926x926x95biL8sOT8sOT8sOT8sOT8sOT8sOT8sOT8sOT8sOT5biL5biL5biL5biL5biL5biL5biLxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxx5biL5biL5biL5biL5biL5biL5biL5biL5biL5biL8sOT8sOT8sOT8sOT8sOT8sOT26x926x926x926x926x926x95biL5biL5biL26x926x95biL26x926x926x95biL5biL8sOT8sOT8sOT8sOT8sOT8sOT8sOT8sOT8sOT5biL5biL5biL5biL5biL5biLxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxxxpxx8sOT8sOT8sOT8sOT8sOT8sOT5biL5biL5biL5biL5biL5biL5biL5biL5biL5biL5biL26x926x95biL5biL26x926x926x95biL5biL26x926x95biL26x926x95biL"),
"format": "RGB8",
"height": 16,
"mipmaps": false,
"width": 16
}

[sub_resource type="Texture2DArray" id="Texture2DArray_pkg7o"]
_images = Array[Image]([SubResource("Image_aqk2v"), SubResource("Image_036b0"), SubResource("Image_dwbse")])

[sub_resource type="ShaderMaterial" id="ShaderMaterial_tlwt5"]
render_priority = 0
shader = SubResource("Shader_036b0")
shader_parameter/u_transition_mask = 0
shader_parameter/u_texture_array = SubResource("Texture2DArray_pkg7o")

[sub_resource type="VoxelStreamMemory" id="VoxelStreamMemory_f3sb7"]

[sub_resource type="FastNoiseLite" id="FastNoiseLite_tlwt5"]
fractal_type = 0

[sub_resource type="FastNoiseLite" id="FastNoiseLite_fj7yv"]

[sub_resource type="VoxelGeneratorGraph" id="VoxelGeneratorGraph_tlwt5"]
graph_data = {
"connections": [[10, 0, 11, 2], [11, 0, 9, 0], [5, 0, 8, 0], [6, 0, 7, 0], [7, 0, 5, 1], [8, 0, 4, 0]],
"nodes": {
"10": {
"auto_connect": true,
"gui_position": Vector2(340, 360),
"noise": SubResource("FastNoiseLite_tlwt5"),
"type": "Noise3D",
"x": 0.0,
"y": 0.0,
"z": 0.0
},
"11": {
"a": 0.0,
"b": 1.0,
"gui_position": Vector2(640, 380),
"threshold": 0.0,
"type": "Select"
},
"4": {
"auto_connect": true,
"gui_position": Vector2(940, 140),
"type": "OutputSDF"
},
"5": {
"auto_connect": true,
"gui_position": Vector2(520, 140),
"type": "SdfPlane",
"y": 0.0
},
"6": {
"auto_connect": true,
"gui_position": Vector2(120, 160),
"noise": SubResource("FastNoiseLite_fj7yv"),
"type": "Noise2D",
"x": 0.0,
"y": 0.0
},
"7": {
"b": 20.0,
"gui_position": Vector2(340, 160),
"type": "Multiply"
},
"8": {
"gui_position": Vector2(740, 140),
"max": 1.0,
"min": -1.0,
"type": "Clamp"
},
"9": {
"gui_position": Vector2(920, 380),
"type": "OutputSingleTexture"
}
},
"version": 2
}

[sub_resource type="VoxelMesherTransvoxel" id="VoxelMesherTransvoxel_pkg7o"]
texturing_mode = 1

[sub_resource type="BoxMesh" id="BoxMesh_pkg7o"]

[sub_resource type="BoxShape3D" id="BoxShape3D_gbfbk"]

[sub_resource type="BoxShape3D" id="BoxShape3D_ioo17"]

[sub_resource type="SphereMesh" id="SphereMesh_wse8f"]

[node name="World" type="Node3D"]

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource("Environment_aqk2v")

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="."]
transform = Transform3D(-0.8660254, -0.43301278, 0.25, 0, 0.49999997, 0.86602545, -0.50000006, 0.75, -0.43301266, 0, 0, 0)
shadow_enabled = true

[node name="VoxelLodTerrain" type="VoxelLodTerrain" parent="."]
lod_count = 6
material = SubResource("ShaderMaterial_tlwt5")
collision_layer = 5
collision_mask = 5
stream = SubResource("VoxelStreamMemory_f3sb7")
generator = SubResource("VoxelGeneratorGraph_tlwt5")
mesher = SubResource("VoxelMesherTransvoxel_pkg7o")
render_layers_mask = 5
script = ExtResource("1_fj7yv")

[node name="Player" parent="." instance=ExtResource("1_f3sb7")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 3.9875867, 0)
safe_margin = 0.05
terreno_path = NodePath("../VoxelLodTerrain")

[node name="Label" type="Label" parent="."]
offset_right = 40.0
offset_bottom = 23.0
text = "Godot Voxel Tool by Zylann.
Demo by PiCode.
SimpleFirstPerson (controller) by aarroz.

Control:
Move - WASD & Space
Sprint - Shift
Place - Left mouse
Break - Right mouse
Switch material - E
"

[node name="camion volquete" type="VehicleBody3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1.1842539, -6.062912)

[node name="MeshInstance3D" type="MeshInstance3D" parent="camion volquete"]
mesh = SubResource("BoxMesh_pkg7o")

[node name="CollisionShape3D" type="CollisionShape3D" parent="camion volquete"]
shape = SubResource("BoxShape3D_gbfbk")

[node name="Area3D" type="Area3D" parent="camion volquete"]
collision_layer = 5
collision_mask = 5
script = ExtResource("3_tlwt5")
tierra_escena = ExtResource("4_aqk2v")

[node name="CollisionShape3D" type="CollisionShape3D" parent="camion volquete/Area3D"]
transform = Transform3D(2, 0, 0, 0, 2, 0, 0, 0, 2, 0, 0, 0)
shape = SubResource("BoxShape3D_ioo17")

[node name="visual" type="MeshInstance3D" parent="camion volquete"]
mesh = SubResource("SphereMesh_wse8f")

[node name="PuntoDescarga" type="Marker3D" parent="camion volquete"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 4.5677023, 0)
